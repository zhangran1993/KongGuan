////  SimpleDemoViewController.m//  SimpleDemo////  Created by apple on 11-4-2.//  Copyright __MyCompanyName__ 2011. All rights reserved.//#import "SimpleDemoViewController.h"#import "hcnetsdk.h"#import "HikDec.h"#import "Preview.h"#import "EzvizTrans.h"#import "FrameBaseRequest.h"@implementation SimpleDemoViewController@synthesize m_playView;@synthesize m_lUserID;@synthesize m_lRealPlayID;@synthesize m_lPlaybackID;@synthesize m_bPreview;SimpleDemoViewController *g_pController = NULL;int g_iStartChan = 0;int g_iPreviewChanNum = 0;void g_fExceptionCallBack(DWORD dwType, LONG lUserID, LONG lHandle, void *pUser){    NSLog(@"g_fExceptionCallBack Type[0x%x], UserID[%d], Handle[%d]", dwType, lUserID, lHandle);}BOOL NET_DVR_PTZControl(                        LONG     lRealHandle,                        DWORD    dwPTZCommand,                        DWORD    dwStop                        );BOOL NET_DVR_PTZControlWithSpeed(                                 LONG     lRealHandle,                                 DWORD    dwPTZCommand,                                 DWORD    dwStop,                                 DWORD    dwSpeed                                 );-(void)playNow{    NSLog(@"loginBtnClicked");        BOOL bRet = NET_DVR_Init();    if (!bRet){        NSLog(@"NET_DVR_Init failed");    }        NSString *documentPath = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) objectAtIndex:0];    const char* pDir = [documentPath UTF8String];    NET_DVR_SetLogToFile(3, (char*)pDir, true);    g_iStartChan = 32 + _channelId;    if([self loginNormalDevice]){        m_lRealPlayID = startPreview(m_lUserID, g_iStartChan, m_playView, 0);        if(m_lRealPlayID >= 0)        {            m_bPreview = true;        }    }}- (bool) loginNormalDevice{        //  Get value    NSString * iP = _ip;//@"192.168.0.178";    NSString * port = _port;//@"8000";    NSString * usrName =  _name;//@"admin";    NSString * password = _password;//@"kg123456";        DeviceInfo *deviceInfo = [[DeviceInfo alloc] init];    deviceInfo.chDeviceAddr = iP;    deviceInfo.nDevicePort = (int)[port intValue];    deviceInfo.chLoginName = usrName;    deviceInfo.chPassWord = password;        // device login    NET_DVR_DEVICEINFO_V30 logindeviceInfo = {0};        // encode type    NSStringEncoding enc = CFStringConvertEncodingToNSStringEncoding(kCFStringEncodingGB_18030_2000);    m_lUserID = NET_DVR_Login_V30((char*)[deviceInfo.chDeviceAddr UTF8String],                                  deviceInfo.nDevicePort,                                  (char*)[deviceInfo.chLoginName cStringUsingEncoding:enc],                                  (char*)[deviceInfo.chPassWord UTF8String],                                  &logindeviceInfo);        printf("iP:%s\n", (char*)[deviceInfo.chDeviceAddr UTF8String]);    printf("Port:%d\n", deviceInfo.nDevicePort);    printf("UsrName:%s\n", (char*)[deviceInfo.chLoginName cStringUsingEncoding:enc]);    printf("Password:%s\n", (char*)[deviceInfo.chPassWord UTF8String]);        // login on failed    if (m_lUserID == -1)    {        [FrameBaseRequest showMessage:@"获取视频出错"];        [self backAction];        /*         UIAlertView *alert = [[UIAlertView alloc]         initWithTitle:kWarningTitle         message:kLoginDeviceFailMsg         delegate:nil         cancelButtonTitle:kWarningConfirmButton         otherButtonTitles:nil];         [alert show];         [alert release];         */        return false;    }        if(logindeviceInfo.byChanNum > 0)    {        g_iStartChan = logindeviceInfo.byStartChan;        g_iPreviewChanNum = logindeviceInfo.byChanNum;    }    else if(logindeviceInfo.byIPChanNum > 0)    {        g_iStartChan = logindeviceInfo.byStartDChan;        g_iPreviewChanNum = logindeviceInfo.byIPChanNum + logindeviceInfo.byHighDChanNum * 256;    }    NSLog(@"g_iStartChan  %d::%d",g_iStartChan,_channelId);    g_iStartChan = 32+ _channelId;    return true;}// Implement viewDidLoad to do additional setup after loading the view, typically from a nib.- (void)viewDidLoad {    [super viewDidLoad];        m_lUserID = -1;    m_lRealPlayID = -1;    m_lPlaybackID = -1;    [self playNow];            m_multiView = [[UIView alloc] initWithFrame:CGRectMake(0,0, m_playView.frame.size.width, m_playView.frame.size.height)];    m_multiView.backgroundColor = [UIColor clearColor];    [m_playView addSubview:m_multiView];        self.view.backgroundColor = [UIColor blackColor];    UIView *bottomView = [[UIView alloc]init];    [self.view addSubview:bottomView];    bottomView.backgroundColor = [UIColor clearColor];    //    bottomView.hidden = YES;    [bottomView mas_makeConstraints:^(MASConstraintMaker *make) {        make.height.equalTo(@200);        make.left.equalTo(self.view.mas_left);        make.right.equalTo(self.view.mas_right);        make.width.equalTo(@(WIDTH_SCREEN));        make.bottom.equalTo(self.view.mas_bottom);    }];        UIImage *leftImage = [UIImage imageNamed:@"video_top"];        //改变该图片的方向    leftImage = [UIImage imageWithCGImage:leftImage.CGImage                                    scale:leftImage.scale                              orientation:UIImageOrientationLeft];        UIButton *leftBtn =  [[UIButton alloc]init];    [bottomView addSubview:leftBtn];    [leftBtn setImage:leftImage forState:UIControlStateNormal];    [leftBtn addTarget:self action:@selector(leftClicked:) forControlEvents:UIControlEventTouchDown];    //    UILongPressGestureRecognizer *leftPress = [[UILongPressGestureRecognizer alloc] initWithTarget:self action:@selector(btnLeftLong:)];    //    //    leftPress.minimumPressDuration = 0.2; //定义按的时间    //    [leftBtn addGestureRecognizer:leftPress];    [leftBtn mas_makeConstraints:^(MASConstraintMaker *make) {        make.left.equalTo(@50);        make.top.equalTo(@50);        make.width.height.equalTo(@50);    }];    leftBtn.adjustsImageWhenHighlighted = NO;    UIButton *topBtn =  [[UIButton alloc]init];    topBtn.adjustsImageWhenHighlighted = NO;    [bottomView addSubview:topBtn];    [topBtn setImage:[UIImage imageNamed:@"video_top"] forState:UIControlStateNormal];    [topBtn addTarget:self action:@selector(topMethod:) forControlEvents:UIControlEventTouchUpInside];    [topBtn mas_makeConstraints:^(MASConstraintMaker *make) {        make.left.equalTo(leftBtn.mas_right).offset(10);        make.top.equalTo(leftBtn.mas_top).offset(-55);        make.width.height.equalTo(@50);    }];    UIImage *rightImage = [UIImage imageNamed:@"video_top"];        //改变该图片的方向    rightImage = [UIImage imageWithCGImage:rightImage.CGImage                                     scale:rightImage.scale                               orientation:UIImageOrientationRight];            UIButton *rightBtn =  [[UIButton alloc]init];    rightBtn.adjustsImageWhenHighlighted = NO;    [bottomView addSubview:rightBtn];    [rightBtn setImage:rightImage forState:UIControlStateNormal];    [rightBtn addTarget:self action:@selector(rightMethod:) forControlEvents:UIControlEventTouchUpInside];    [rightBtn mas_makeConstraints:^(MASConstraintMaker *make) {        make.left.equalTo(topBtn.mas_right).offset(10);        make.centerY.equalTo(leftBtn.mas_centerY);        make.width.height.equalTo(@50);    }];        UIImage *bottomImage = [UIImage imageNamed:@"video_top"];        //改变该图片的方向    bottomImage = [UIImage imageWithCGImage:bottomImage.CGImage                                      scale:bottomImage.scale                                orientation:UIImageOrientationDown];    UIButton *bottomBtn =  [[UIButton alloc]init];    bottomBtn.adjustsImageWhenHighlighted = NO;    [bottomView addSubview:bottomBtn];    [bottomBtn setImage:bottomImage forState:UIControlStateNormal];    [bottomBtn addTarget:self action:@selector(bottomMethod:) forControlEvents:UIControlEventTouchUpInside];    [bottomBtn mas_makeConstraints:^(MASConstraintMaker *make) {        make.left.equalTo(topBtn.mas_left);        make.top.equalTo(leftBtn.mas_bottom).offset(10);        make.width.height.equalTo(@50);    }];    UIButton *addBtn =  [[UIButton alloc]init];    [bottomView addSubview:addBtn];    addBtn.adjustsImageWhenHighlighted = NO;    [addBtn setImage:[UIImage imageNamed:@"video_add"] forState:UIControlStateNormal];    [addBtn addTarget:self action:@selector(addmMethod:) forControlEvents:UIControlEventTouchUpInside];    [addBtn mas_makeConstraints:^(MASConstraintMaker *make) {        make.right.equalTo(self.view.mas_right).offset(-80);        make.bottom.equalTo(leftBtn.mas_top).offset(10);        make.width.height.equalTo(@50);    }];    UIButton *minusBtn =  [[UIButton alloc]init];    [bottomView addSubview:minusBtn];    minusBtn.adjustsImageWhenHighlighted = NO;    [minusBtn setImage:[UIImage imageNamed:@"video_minus"] forState:UIControlStateNormal];    [minusBtn addTarget:self action:@selector(minusMethod:) forControlEvents:UIControlEventTouchUpInside];    [minusBtn mas_makeConstraints:^(MASConstraintMaker *make) {        make.right.equalTo(self.view.mas_right).offset(-80);        make.top.equalTo(leftBtn.mas_bottom).offset(-10);        make.width.height.equalTo(@50);    }];    g_pController = self;    [self backBtn];}//left- (void)leftClicked:(UIButton *)button {        NET_DVR_PTZControl(0,PAN_LEFT,0);    [self performSelector:@selector(endLeft) withObject:nil afterDelay:.5f];    }- (void)endLeft {    NET_DVR_PTZControl(0,PAN_LEFT,1);}//right- (void)rightMethod:(UIButton *)button {    NSLog(@"right");    NET_DVR_PTZControl(0,PAN_RIGHT,0);    [self performSelector:@selector(endRight) withObject:nil afterDelay:.5f];}- (void)endRight {    NET_DVR_PTZControl(0,PAN_RIGHT,1);    NSLog(@"NET_DVR_RealPlay_V40 failed:%d",  NET_DVR_GetLastError());    int errorNum =NET_DVR_GetLastError();    if(errorNum != 0 ) {        [FrameBaseRequest showMessage:@"暂无权限"];    }}//top- (void)topMethod:(UIButton *)button {    NSLog(@"top");    NET_DVR_PTZControl(0,TILT_UP,0);    [self performSelector:@selector(endTop) withObject:nil afterDelay:.5f];}- (void)endTop {    NET_DVR_PTZControl(0,TILT_UP,1);    int errorNum =NET_DVR_GetLastError();    if(errorNum != 0 ) {        [FrameBaseRequest showMessage:@"暂无权限"];    }}//bottom- (void)bottomMethod:(UIButton *)button {    NSLog(@"bottom");    NET_DVR_PTZControl(0,TILT_DOWN,0);    [self performSelector:@selector(endBottom) withObject:nil afterDelay:.5f];}- (void)endBottom {    NET_DVR_PTZControl(0,TILT_DOWN,1);    int errorNum =NET_DVR_GetLastError();    if(errorNum != 0 ) {        [FrameBaseRequest showMessage:@"暂无权限"];    }}//zoomout- (void)minusMethod:(UIButton *)button {    NSLog(@"minus");    NET_DVR_PTZControl(0,ZOOM_OUT,0);    [self performSelector:@selector(endZoomOut) withObject:nil afterDelay:.5f];}- (void)endZoomOut {    NET_DVR_PTZControl(0,ZOOM_OUT,1);    int errorNum =NET_DVR_GetLastError();    if(errorNum != 0 ) {        [FrameBaseRequest showMessage:@"暂无权限"];    }}//zoomin- (void)addmMethod:(UIButton *)button {    NSLog(@"add");    NET_DVR_PTZControl(0,ZOOM_IN,0);    [self performSelector:@selector(endZoomIn) withObject:nil afterDelay:.5f];}- (void)endZoomIn {    NET_DVR_PTZControl(0,ZOOM_IN,1);    int errorNum =NET_DVR_GetLastError();    if(errorNum != 0 ) {        [FrameBaseRequest showMessage:@"暂无权限"];    }}- (void)didReceiveMemoryWarning {    // Releases the view if it doesn't have a superview.    [super didReceiveMemoryWarning];        // Release any cached data, images, etc that aren't in use.}- (void)viewDidUnload {    if (m_lRealPlayID != -1)    {        NET_DVR_StopRealPlay(m_lRealPlayID);        m_lRealPlayID = -1;    }        if(m_lPlaybackID != -1)    {        NET_DVR_StopPlayBack(m_lPlaybackID);        m_lPlaybackID = -1;    }        if(m_lUserID != -1)    {        NET_DVR_Logout(m_lUserID);        NET_DVR_Cleanup();        m_lUserID = -1;    }    //  [test drain];}- (void)dealloc {    if (m_playView != nil)    {        [m_playView release];        m_playView = nil;    }        [super dealloc];}-(void)backBtn{    UIButton *leftButon = [UIButton buttonWithType:UIButtonTypeRoundedRect];    leftButon.frame = CGRectMake(0,0,FrameWidth(40),FrameWidth(40));    [leftButon setImage:[UIImage imageNamed:@"back_icon"] forState:UIControlStateNormal];    [leftButon setContentEdgeInsets:UIEdgeInsetsMake(0, - FrameWidth(17), 0, FrameWidth(17))];    //button.alignmentRectInsetsOverride = UIEdgeInsetsMake(0, offset, 0, -(offset));    [leftButon addTarget:self action:@selector(backAction) forControlEvents:UIControlEventTouchUpInside];    UIBarButtonItem *fixedButton = [[UIBarButtonItem alloc]initWithCustomView:leftButon];    self.navigationItem.leftBarButtonItem = fixedButton;    self.navigationController.navigationBar.tintColor = [UIColor whiteColor];    }-(void)backAction {    [self.navigationController popViewControllerAnimated:YES];}@end